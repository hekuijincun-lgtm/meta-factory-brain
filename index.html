<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– ãƒ¡ã‚¿å·¥å ´ God Mode ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    
    <!-- è¨­å®š & ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-6 mb-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 flex items-center">
            <span class="mr-2">ğŸ­</span> ãƒ¡ã‚¿å·¥å ´ God Mode ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        </h1>
        <p class="text-sm text-gray-500 mb-6">ç¾åœ¨ã®å·¥å ´URL: <span id="factory-url" class="font-mono text-xs bg-gray-100 p-1 rounded"></span></p>

        <!-- æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 shadow-inner">
            <h2 class="text-xl font-semibold text-yellow-800 mb-3">ğŸ” æ‰‹å‹•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³</h2>
            <p class="text-sm text-gray-600 mb-3">æ–°ã—ã„ç«¶åˆã®URLã‚’å…¥åŠ›ã—ã€å³åº§ã«å¼±ç‚¹åˆ†æã‚’è¡Œã„ã¾ã™ã€‚</p>
            <div class="flex flex-col md:flex-row gap-3">
                <input type="url" id="scan-url" placeholder="ä¾‹: https://example.com/competitor-lp" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shadow-sm" required>
                <button onclick="triggerScan()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 whitespace-nowrap" id="scan-button">
                    ã‚¹ã‚­ãƒ£ãƒ³ï¼†DBä¿å­˜
                </button>
            </div>
            <p id="scan-message" class="mt-3 text-sm text-gray-700 hidden"></p>
        </div>
    </div>

    <!-- ã‚¢ã‚¤ãƒ‡ã‚¢ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ§  ã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆè³‡ç”£ï¼‰ä¸€è¦§</h2>
        
        <div class="overflow-x-auto scrollable-content">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç«¶åˆ/URL</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¼±ç‚¹ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒãƒ£ãƒ³ã‚¹ï¼‰</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">LPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                    </tr>
                </thead>
                <tbody id="ideas-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                    <tr>
                        <td colspan="5" class="py-4 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p class="text-right text-xs text-gray-400 mt-4">æœ€çµ‚æ›´æ–°: <span id="last-updated">--</span></p>
    </div>

    <script>
        // â˜…â˜…â˜… ãƒ¡ã‚¿å·¥å ´ã®ãƒ™ãƒ¼ã‚¹URLã‚’ã“ã“ã«è¨­å®š â˜…â˜…â˜…
        const FACTORY_BASE_URL = "https://meta-factory-brain.hekuijincun.workers.dev";
        document.getElementById('factory-url').textContent = FACTORY_BASE_URL;

        /**
         * APIã‹ã‚‰ã‚¢ã‚¤ãƒ‡ã‚¢ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
         */
        async function fetchIdeas() {
            const tableBody = document.getElementById('ideas-table-body');
            tableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-blue-500">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</td></tr>`;
            
            try {
                const response = await fetch(`${FACTORY_BASE_URL}/ideas`);

                if (!response.ok) {
                    throw new Error(`APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ (Status: ${response.status} - CORSãƒ–ãƒ­ãƒƒã‚¯ã®å¯èƒ½æ€§)`);
                }
                
                const ideas = await response.json();
                
                if (ideas && ideas.length > 0) {
                    renderTable(ideas);
                } else {
                    tableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³ã§æœ€åˆã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</td></tr>`;
                }

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Error fetching ideas:', error);
                tableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-red-500">
                    âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>
                    Workerå´ã®CORSè¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    </td></tr>`;
            }
        }

        /**
         * ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         */
        function renderTable(ideas) {
            const tableBody = document.getElementById('ideas-table-body');
            tableBody.innerHTML = ''; // ã‚¯ãƒªã‚¢

            ideas.forEach(idea => {
                const weaknesses = JSON.parse(idea.weaknesses || '[]');
                
                // LPç”Ÿæˆæ¸ˆã¿ã‹ã©ã†ã‹
                const isLpGenerated = idea.lp_html !== null;
                const statusClass = isLpGenerated ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = isLpGenerated ? 'âœ… å…¬é–‹æº–å‚™OK' : 'âŒ æœªç”Ÿæˆ';

                const row = `
                    <tr id="row-${idea.id}">
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${idea.id}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                            <span class="font-semibold text-gray-800">${idea.competitor_name}</span><br>
                            <span class="text-xs text-blue-500 truncate block">${idea.url}</span>
                        </td>
                        <td class="px-3 py-3 text-sm text-gray-700 max-w-sm">
                            <ul class="list-disc list-inside text-xs space-y-0.5">
                                ${weaknesses.map(w => `<li class="truncate">${w}</li>`).join('')}
                            </ul>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium space-x-2">
                            ${isLpGenerated 
                                ? `<a href="${FACTORY_BASE_URL}/view/${idea.id}" target="_blank" class="text-indigo-600 hover:text-indigo-900 text-xs font-semibold p-2 rounded-lg bg-indigo-50 hover:bg-indigo-100 transition shadow-sm">LPè¡¨ç¤º</a>`
                                : `<button onclick="generateLp(${idea.id})" class="text-yellow-700 hover:text-yellow-900 text-xs font-semibold p-2 rounded-lg bg-yellow-100 hover:bg-yellow-200 transition shadow-sm" id="gen-btn-${idea.id}">LPç”Ÿæˆ</button>`
                            }
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        /**
         * LPç”ŸæˆAPIã‚’å©ã
         */
        async function generateLp(id) {
            const button = document.getElementById(`gen-btn-${id}`);
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'ç”Ÿæˆä¸­...';
            button.classList.add('animate-pulse');

            try {
                const response = await fetch(`${FACTORY_BASE_URL}/generate-lp?id=${id}`);
                const result = await response.json();

                if (response.ok) {
                    alert(`LPç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼Stripeãƒªãƒ³ã‚¯ã‚‚è‡ªå‹•ã§åŸ‹ã‚è¾¼ã¾ã‚Œã¾ã—ãŸã€‚`);
                    fetchIdeas(); // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                } else {
                    alert(`LPç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.details || result.error}`);
                }
            } catch (error) {
                console.error('LP generation error:', error);
                alert('LPç”Ÿæˆä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
                button.classList.remove('animate-pulse');
            }
        }

        /**
         * æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³APIã‚’å©ã
         */
        async function triggerScan() {
            const urlInput = document.getElementById('scan-url');
            const scanButton = document.getElementById('scan-button');
            const messageDiv = document.getElementById('scan-message');
            const url = urlInput.value;

            if (!url) {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            scanButton.disabled = true;
            scanButton.textContent = 'åˆ†æä¸­...';
            scanButton.classList.add('animate-pulse');
            messageDiv.classList.remove('hidden', 'text-green-600', 'text-red-600');
            messageDiv.textContent = 'AIãŒå¼±ç‚¹åˆ†æä¸­ã§ã™...';

            try {
                const response = await fetch(`${FACTORY_BASE_URL}/scan?url=${encodeURIComponent(url)}`);
                const result = await response.json();

                if (response.ok) {
                    messageDiv.textContent = `âœ… åˆ†æãŒå®Œäº†ã—ã€ID ${result.newId} ã§DBã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚`;
                    messageDiv.classList.replace('text-gray-700', 'text-green-600');
                    urlInput.value = '';
                    fetchIdeas(); // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                } else {
                    messageDiv.textContent = `âŒ ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—: ${result.details || result.error}`;
                    messageDiv.classList.replace('text-gray-700', 'text-red-600');
                }
            } catch (error) {
                console.error('Scan error:', error);
                messageDiv.textContent = `âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                messageDiv.classList.replace('text-gray-700', 'text-red-600');
            } finally {
                scanButton.disabled = false;
                scanButton.textContent = 'ã‚¹ã‚­ãƒ£ãƒ³ï¼†DBä¿å­˜';
                scanButton.classList.remove('animate-pulse');
            }
        }

        // èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
        window.onload = fetchIdeas;
    </script>
</body>
</html>
